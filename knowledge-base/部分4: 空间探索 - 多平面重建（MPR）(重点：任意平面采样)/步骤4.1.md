# 步骤4.1: MPR 原理与虚拟采样平面、以及对应采样平面的宽高变化计算

## 核心理论

我们已经成功将三维的体素数据加载到了 `Data3DTexture` 中，并实现了在轴位（Axial）上的流畅切片浏览。这就像我们拥有了一本逐页扫描的“人体之书”，可以一页一页地翻看。

但是，在真实的医疗诊断场景中，医生往往需要从不同的角度观察病灶。MPR 技术，就是能让我们从任意角度“切开”这本三维的人体之书，观察任意一个剖面的能力。

### 1. 核心原理：虚拟采样平面 (Virtual Sampling Plane)

MPR 的思想不再局限于沿着 Z 轴采样，而是**在三维体数据中定义一个任意位置、任意朝向的虚拟平面**。我们的任务，就是计算出这个虚拟平面与我们三维体素数据相交区域的像素值，然后将这个“剖面图”渲染出来。

这个虚拟平面可以是我们熟悉的**矢状位（Sagittal）**和**冠状位（Coronal）**，也可以是任意倾斜的**斜切位（Oblique）**。

<img width="600" src="https://assets.leima.tech/images/blog/mpr/mpr-planes.jpeg" />

### 2. 如何定义一个虚拟采样平面？

在三维空间中，定义一个平面，我们通常需要两个关键信息：

- **一个基点 (Origin)**：这个点是平面上的任意一点，通常我们会选择平面的中心点。它定义了平面在空间中的**位置**。
- **两个正交的单位向量 (Basis Vectors)**：这两个向量，我们称之为 `xAxis` 和 `yAxis`，它们相互垂直，并且长度为1。它们共同定义了平面在空间中的**朝向**。`xAxis` 可以看作是渲染出的二维图像的“横轴”方向，`yAxis` 则是“纵轴”方向。

有了这三个向量（`origin`, `xAxis`, `yAxis`），我们就可以唯一确定空间中的一个矩形采样区域了。

### 3. 如何计算采样点的坐标？

对于屏幕上的每一个像素点 `(u, v)`（`u` 和 `v` 的范围我们设计为从 -0.5 到 0.5），我们都需要找到它对应在三维体数据中**应该采样哪个位置的体素值**。

这个计算过程可以用一个简单的向量方程来表示：

`SamplePosition_in_3D = Origin + (u * xAxis * PlaneWidth) + (v * yAxis * PlaneHeight)`

- `SamplePosition_in_3D`: 这就是我们最终要在三维纹理中进行采样的那个点的三维坐标。
- `Origin`: 我们定义的平面基点。
- `u, v`: 屏幕像素对应的二维坐标（-0.5 到 0.5）。
- `xAxis`, `yAxis`: 我们定义的平面方向向量。
- `PlaneWidth`, `PlaneHeight`: 采样平面的实际宽高，单位通常是毫米（mm）。

这个公式的几何意义非常直观：从原点 `Origin` 出发，沿着平面的 `xAxis` 方向走 `u * PlaneWidth` 的距离，再沿着 `yAxis` 方向走 `v * PlaneHeight` 的距离，就到达了目标采样点。

### 4. 关键挑战：采样平面的宽高如何确定？

`PlaneWidth` 和 `PlaneHeight` 并不是一个固定的值，它取决于虚拟平面的**朝向**以及我们整个三维数据体的**尺寸**。

一个常用的、比较稳妥的计算方法是：计算出整个三维数据体包围盒（Bounding Box）的**对角线长度**。任何一个穿过中心的平面，其最大可能的尺寸都不会超过这个对角线的长度。我们可以用这个对角线长度作为所有平面视图的宽高，从而确保任何角度的切片都能被完整显示。

假设我们的三维数据体在 X、Y、Z 三个轴上的物理尺寸（毫米）分别是 `sizeX`, `sizeY`, `sizeZ`，那么包围盒的对角线长度 `diagonal` 可以通过三维空间中的勾股定理计算得出：

`diagonal = sqrt(sizeX² + sizeY² + sizeZ²)`

然后，我们可以让 `PlaneWidth` 和 `PlaneHeight` 都等于这个 `diagonal` 值。

### 总结表格

| 概念             | 描述                                                                                                                                | 在 GLSL 中对应                                                        |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| **虚拟采样平面** | 在三维体数据中由程序定义的、用于提取图像信息的任意二维平面。                                                                        | 通过一组 Uniforms (origin, xAxis, yAxis) 定义                         |
| **平面定义**     | 由一个基点 `origin` (位置) 和两个正交单位向量 `xAxis`, `yAxis` (朝向) 共同确定。                                                    | `uniform vec3 uOrigin;` `uniform vec3 uXAxis;` `uniform vec3 uYAxis;` |
| **采样点计算**   | `SamplePosition = Origin + u * xAxis * Width + v * yAxis * Height`。根据屏幕像素的二维坐标 `(u,v)` 计算出其在三维空间中的采样坐标。 | 顶点着色器或片元着色器中的核心计算逻辑                                |
| **平面宽高**     | 为确保任意朝向的切片都能完整显示，通常取整个三维数据体**包围盒的对角线长度**作为平面的宽高。                                        | `uniform float uPlaneWidth;` `uniform float uPlaneHeight;`            |

---

## 学员问题与导师解答

**问题**: 对于 `屏幕是由一个个像素组成的网格，对于屏幕上的每一个像素点 (u, v)（u 和 v 的范围通常是从 -0.5 到 0.5，代表从图像的一端到另一端）` 这句话没看懂，uv 怎么变成-0.5到0.5了？不是0到1嘛？还是说ndc？ndc不是-1到1嘛？还是说因为origin从原点挪到了中心点 所以-0.5到0.5是相对于中心点来说的？

**回答**:

这是个非常好的问题，切中了关键细节。`u,v` 的范围到底是 `0` 到 `1` 还是 `-0.5` 到 `0.5`，这完全取决于我们的**设计选择**。不同的选择会对应稍微不同的计算公式，但最终都能达到同样的目的。

我们来梳理一下这几种坐标系：

1.  **纹理坐标 (Texture Coordinates)**:

    - **范围**: `(0, 0)` 到 `(1, 1)`
    - **原点**: 通常在图像的**左下角**。
    - **用途**: 用于在纹理上进行采样。

2.  **归一化设备坐标 (Normalized Device Coordinates, NDC)**:

    - **范围**: `(-1, -1)` 到 `(1, 1)`
    - **原点**: 在屏幕的**正中心**。
    - **用途**: 顶点着色器最终输出 `gl_Position` 所在的坐标系。

3.  **我们自定义的“平面坐标” (`-0.5` 到 `0.5`)**:
    - **范围**: `(-0.5, -0.5)` 到 `(0.5, 0.5)`
    - **原点**: 我们**设计**在渲染平面的**正中心**。
    - **用途**: 为了方便理解和 MPR 计算而**特意设计**的一种坐标系。

**为什么选择 `-0.5` 到 `0.5`？**

这主要是为了让我们的采样公式在几何上更加**对称和直观**。

我们的核心公式：
`SamplePosition_in_3D = Origin + (u * xAxis * PlaneWidth) + (v * yAxis * PlaneHeight)`

- **`Origin` 的选择**: 在 MPR 应用中，最方便的 `Origin` 点就是整个三维数据体**中心点**。
- **计算的对称性**: 如果我们把 `Origin` 定义在数据体的中心，那么很自然地，我们也希望渲染平面的坐标原点 `(u=0, v=0)` 正好对应这个 `Origin` 点。
  - 当 `(u,v) = (0,0)` 时，`SamplePosition` 就直接等于 `Origin`。
  - 当 `u` 从 `-0.5` 变化到 `0.5` 时，采样点就沿着 `xAxis` 方向，从 `Origin - 0.5 * xAxis * PlaneWidth` 线性移动到 `Origin + 0.5 * xAxis * PlaneWidth`，正好是从平面的一端走到另一端。

**对比一下，如果我们使用 `0` 到 `1` 的范围会怎么样？**

当然也可以！如果我们坚持使用 `0` 到 `1` 的范围，` (u,v)` 的原点 `(0,0)` 就会在平面的**左下角**。为了让采样仍然围绕数据体中心进行，公式会变成这样：

`SamplePosition_in_3D = Origin + ((u - 0.5) * xAxis * PlaneWidth) + ((v - 0.5) * yAxis * PlaneHeight)`

这个 `(u - 0.5)` 的结果，不就正好是从 `-0.5` 到 `0.5` 吗？

**总结**

| 坐标系选择                 | `u, v` 范围   | `Origin` 定义                 | 采样公式                                                          | 优缺点                                                                                                                       |
| -------------------------- | ------------- | ----------------------------- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **自定义平面坐标（推荐）** | `(-0.5, 0.5)` | 数据体中心                    | `Origin + u * xAxis * Width + v * yAxis * Height`                 | **优点**: 公式简洁，几何意义清晰，完美对称。<br/>**缺点**: 需要在顶点着色器里对输入的 `uv` (0->1) 做一次 `uv - 0.5` 的转换。 |
| **标准纹理坐标**           | `(0, 1)`      | 数据体中心 (为了保持视图中心) | `Origin + (u - 0.5) * xAxis * Width + (v - 0.5) * yAxis * Height` | **优点**: 直接使用顶点数据，无需转换。<br/>**缺点**: 公式中带有 ` - 0.5` 的偏移，直观性稍差。                                |

所以，我们通常会在顶点着色器（Vertex Shader）中，先将从 `PlaneGeometry` 获得的 `0` 到 `1` 的 `uv` 坐标转换成 `-0.5` 到 `0.5` 的坐标，再传递给片元着色器（Fragment Shader）。这个小小的转换，体现了图形学编程中一个很常见的思想：**通过选择合适的坐标系来简化问题**。
