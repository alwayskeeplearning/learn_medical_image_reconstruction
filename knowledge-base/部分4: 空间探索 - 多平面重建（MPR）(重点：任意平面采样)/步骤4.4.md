# 知识库：步骤 4.4 - 实践：正交三平面（统一空间渲染）

## 1. 核心目标

在一个统一的 3D 场景中，同时渲染并显示相互垂直的三个正交平面（轴位、冠状位、矢状位）。重点在于理解**三维纹理采样**与**病人空间坐标变换**的结合，以及如何通过复用同一套 Shader 逻辑来渲染不同方向的切片。

---

## 2. 核心算法：任意平面采样 (MPR)

### 2.1 空间点转换公式

每一个切片平面都是由其**中心点 (`uOrigin`)**、**局部 X 轴方向 (`uXAxis`)** 和 **局部 Y 轴方向 (`uYAxis`)** 定义的。在 GPU 中，对于平面上的每一个 UV 点，其对应的病人坐标系位置 $P_{patient}$ 为：

$$P_{patient} = uOrigin + (vUv.x - 0.5) * uXAxis * uPlaneWidth + (vUv.y - 0.5) * uYAxis * uPlaneHeight$$

然后通过 **Patient-to-Voxel 矩阵** 将该物理点转回纹理索引坐标：

$$P_{voxel} = M_{P \to V} \cdot P_{patient}$$

### 2.2 正交方向定义

为了在 3D 空间中正确摆放这三个平面，我们需要为它们配置不同的方向向量：

| 视图                  | 默认法向量 (Normal) | X轴方向 (uXAxis) | Y轴方向 (uYAxis) |
| :-------------------- | :------------------ | :--------------- | :--------------- |
| **轴位 (Axial)**      | (0, 0, 1)           | (1, 0, 0)        | (0, 1, 0)        |
| **冠状位 (Coronal)**  | (0, 1, 0)           | (1, 0, 0)        | (0, 0, -1)       |
| **矢状位 (Sagittal)** | (1, 0, 0)           | (0, 0, -1)       | (0, 1, 0)        |

---

## 3. 实现关键点

### 3.1 3D 纹理构建

- 使用 `THREE.Data3DTexture` 存储整个序列。
- 必须设置 `LinearFilter` 以实现切片间的平滑插值（否则在非轴位方向上会有明显的锯齿）。
- 确保 `unpackAlignment = 1`，避免非 4 字节对齐导致的数据偏移。

### 3.2 矩阵中心化

为了方便 3D 观察，我们将数据体的中心点平移至世界坐标系原点。这意味着在构建 `VoxelToPatientMatrix` 后，需要左乘一个平移矩阵，并重新计算其逆矩阵供 Shader 使用。

### 3.3 采样张数计算

不同方向的物理厚度不同，通过计算数据体 8 个顶点在平面法线上的投影范围，可以动态得到该方向上的总物理厚度，进而根据采样间隔算出总张数。

---

## 4. 实践验证

- **视图交叉**: 在 3D 场景中应能看到三个平面像“十字架”一样互相贯穿。
- **窗宽窗位同步**: 调节 GUI 时，三个平面的对比度应实时、同步地发生变化。
- **切片滚动**: 滚动鼠标滚轮时，当前激活的切片平面应沿其法线方向平滑平移。
