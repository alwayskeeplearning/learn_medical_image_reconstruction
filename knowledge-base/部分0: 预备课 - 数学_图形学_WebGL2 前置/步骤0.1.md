# 步骤0.1: 理论 - 核心数学与坐标系概念

## **1. 向量 (Vector)**

- **核心概念**: 向量是一个同时具有**大小（长度）**和**方向**的量。你可以把它想象成空间中的一个箭头。在 3D 图形学中，我们通常使用三维向量（例如 `(x, y, z)`）来表示：

  - **位置**: 空间中一个点的位置（相对于原点 `(0,0,0)` 的一个箭头）。
  - **方向**: 一个物体的朝向，或者光线的方向。
  - **位移**: 从一个点到另一个点的移动。

- **几何意义**:
  - **点积 (Dot Product)**: `a · b`。点积的结果是一个**标量（一个数字）**，它描述了两个向量方向的**相似程度**。
    - 如果 `a · b > 0`，两个向量方向大致相同（夹角 < 90°）。
    - 如果 `a · b = 0`，两个向量**正交**（互相垂直，夹角 = 90°）。这个特性在计算光照和投影时非常有用。
    - 如果 `a · b < 0`，两个向量方向大致相反（夹角 > 90°）。
  - **叉积 (Cross Product)**: `a × b`。叉积的结果是一个**新的向量**，这个新向量**同时垂直于**原始的两个向量 `a` 和 `b`。
    - 它的主要用途是计算一个平面的**法向量 (Normal Vector)**。法向量定义了平面的朝向，这对于光照计算和判断一个面是否朝向观察者至关重要。

## **2. 矩阵 (Matrix)**

- **核心概念**: 矩阵是一个数字的矩形阵列。在 3D 图形学中，矩阵是我们对物体进行**变换 (Transformation)** 的核心工具。一个 4x4 的矩阵可以封装几乎所有我们需要的变换操作：

  - **平移 (Translate)**: 移动物体的位置。
  - **旋转 (Rotate)**: 围绕一个轴旋转物体。
  - **缩放 (Scale)**: 放大或缩小物体。
  - **投影 (Projection)**: 将 3D 场景“压扁”成 2D 图像，模拟近大远小的透视效果。

  通过将一个点的向量乘以一个变换矩阵，我们就能得到变换后新点的向量。`新位置 = 变换矩阵 × 旧位置`。

## **3. 坐标系 (Coordinate System)**

为了精确描述物体的位置和朝向，我们需要一个参考系，这就是坐标系。在从 3D 模型到最终屏幕像素的渲染旅程中，一个点会经历多个坐标系的变换：

1.  **世界坐标系 (World Space)**: 这是一个全局的、统一的坐标系，用来定义场景中所有物体的位置和方向。你可以把它想象成整个虚拟世界的“大舞台”。

2.  **相机/观察坐标系 (Camera/View Space)**: 这个坐标系是以**相机（或观察者）**为中心的。所有物体的位置都相对于相机来描述。在这个坐标系下，相机位于原点 `(0,0,0)`，看向某个特定的方向（通常是 Z 轴负方向）。

3.  **归一化设备坐标系 (Normalized Device Coordinates, NDC)**: 这是一个非常关键的中间步骤。在投影变换后，所有可见的物体都被映射到一个 `-1` 到 `+1` 的立方体空间内（无论屏幕分辨率是多少）。`x`、`y`、`z` 轴的范围都是 `[-1, 1]`。超出这个范围的任何东西都将被裁剪掉，不会被渲染。这个标准化的立方体使得后续处理变得非常简单。

## **4. 体素 (Voxel) 与毫米 (Millimeter)**

这是医学影像领域特有的重要概念：

- **体素 (Voxel)**: "Volume Pixel" 的缩写，即**体积像素**。它是 3D 医学数据（如 CT 扫描序列）中的最小单位。你可以把它想象成一个微小的立方体，它有一个位置索引 `(i, j, k)` 和一个**数值**（例如 CT 值，代表该点的组织密度）。**体素坐标系**是一个整数坐标系，它不包含物理尺寸信息。

- **毫米 (Millimeter, mm)**: 这是现实世界中的物理单位。DICOM 数据中包含了元数据（例如 `PixelSpacing` 和 `SliceThickness`），它们定义了每个体素在物理空间中的**实际大小**（例如，每个体素代表 0.5mm x 0.5mm x 1.0mm）。通过这些信息，我们可以将体素坐标转换为具有真实物理意义的**毫米坐标**（通常在**病人坐标系 Patient Coordinate System** 中表示），这样才能进行精确的测量和重建。

---

## **问答归档**

**问: “通常在病人坐标系 Patient Coordinate System 中表示” 这句话不太理解，什么是病人坐标系？对比之下还有什么坐标系？**

**答:**
这是一个非常好的问题，它触及了医学影像处理的核心！

**病人坐标系 (Patient Coordinate System, PCS)** 是一个以**病人身体**为基准的、具有真实物理尺寸（通常是毫米）的三维坐标系。它独立于扫描设备，只和病人的解剖方向有关。

简单来说，无论病人是头先进去还是脚先进去扫描，在病人坐标系下：

- X 轴的正方向**总是**指向病人的**左侧 (Left)**。
- Y 轴的正方向**总是**指向病人的**后背 (Posterior)**。
- Z 轴的正方向**总是**指向病人的**头顶 (Superior/Head)**。

这个坐标系通常被称为 **LPS (Left, Posterior, Superior)** 坐标系。

**为什么这个坐标系如此重要？**
因为它为医疗数据提供了**统一的、有临床意义的空间参照**。医生在看影像时，可以毫不含糊地描述病灶的位置（例如“左肺上叶后段”），而这个描述是基于病人身体的，是绝对的。没有这个统一的坐标系，3D 重建、手术导航、多模态影像融合（比如将 CT 和 MRI 图像对齐）都将无从谈起。

---

### **对比之下还有什么坐标系？**

为了更好地理解病人坐标系，我们把它和另外两个在处理流程中紧密相关的坐标系放在一起对比：

1.  **图像/体素坐标系 (Image/Voxel Coordinate System)**

    - **这是我们最原始的数据所在的坐标系。**
    - **单位**: 整数索引 `(i, j, k)`，代表第 `k` 张切片的第 `j` 行、第 `i` 列的那个体素。
    - **原点**: 通常是数据体的一个角，比如第一张切片的左上角。
    - **特点**: **没有物理尺寸，没有方向**。它只是一个三维数组的索引，一个纯粹的、离散的网格。我们无法从中知道一个体素是 1 毫米还是 0.5 毫米大，也无法知道 `i` 增大的方向是病人的左边还是右边。

2.  **世界坐标系 (World Coordinate System)**
    - **这是我们 Three.js 场景中的坐标系。**
    - **单位**: 虚拟单位。我们可以自己定义，但通常为了方便，我们会让 **1 个单位 = 1 毫米**。
    - **原点**: 我们 3D 场景的中心 `(0, 0, 0)`。
    - **特点**: 这是一个虚拟的“舞台”。我们需要把具有真实物理意义的病人影像数据，“摆放”到这个虚拟舞台上进行渲染和交互。通常，我们会让世界坐标系和病人坐标系**对齐**，这样可以简化很多计算。

### **转换流程总结**

我们的整个数据处理和可视化流程，本质上就是一场坐标系的“接力赛”：

**体素坐标系** `(i, j, k)` -> **病人坐标系** `(x, y, z) in mm` -> **世界坐标系** `(in Three.js)`

- **第一步转换 (体素 -> 病人)**: 这一步是**最关键**的，也是医学影像处理的基石。我们通过读取 DICOM 文件中的元数据来完成：

  - `Image Position (Patient) (0020,0032)`: 告诉我们第一张切片左上角体素 `(0,0,0)` 在病人坐标系下的**物理位置 (mm)**。
  - `Image Orientation (Patient) (0020,0037)`: 告诉我们体素网格的行和列分别对应病人坐标系的哪个**方向**。
  - `Pixel Spacing (0028,0030)`: 告诉我们体素在行、列方向上的**物理尺寸 (mm)**。
  - `Slice Thickness (0018,0050)`: 告诉我们体素在切片方向上的**物理尺寸 (mm)**。

- **第二步转换 (病人 -> 世界)**: 这一步通常由我们**自己决定**。最简单的方式就是直接将病人坐标系下的坐标当作世界坐标系下的坐标来使用，相当于把病人模型原封不动地搬到我们的虚拟场景中。
